#!/bin/bash
# Copie dans saintleger.org les Genealogie/Individus avec les fichiers _web
# Dossier source
SOURCE_DIR="/home/arnaud/Documents/Genealogie/Individus"
# Dossier de destination
DEST_DIR="/home/arnaud/Documents/Genealogie/saintleger.org/individus"

# V√©rifie que le dossier source existe
if [ ! -d "$SOURCE_DIR" ]; then
    echo "Le dossier source $SOURCE_DIR n'existe pas."
    exit 1
fi

# Cr√©e le dossier de destination s'il n'existe pas
mkdir -p "$DEST_DIR"
rm -r "$DEST_DIR"/*

# Parcourt chaque dossier dans le dossier source
for individual_dir in "$SOURCE_DIR"/*/; do
    # V√©rifie que c'est bien un dossier
    [ -d "$individual_dir" ] || continue
    
    # R√©cup√®re le nom du dossier
    dir_name=$(basename "$individual_dir")
    
    # Exclure le dossier "Divers"
    if [ "$dir_name" = "Divers" ]; then
        echo "Exclusion du dossier 'Divers'"
        continue
    fi
    
    # Cr√©e le dossier correspondant dans la destination
    dest_individual_dir="$DEST_DIR/$dir_name"
    mkdir -p "$dest_individual_dir"
    
    # Parcourir tous les sous-dossiers
    for subdir in "$individual_dir"/*/; do
        [ -d "$subdir" ] || continue
        
        subdir_name=$(basename "$subdir")
        dest_subdir="$dest_individual_dir/$subdir_name"
        
        # Cr√©er un fichier temporaire avec la liste des fichiers
        temp_file_list=$(mktemp)
        find "$subdir" -maxdepth 1 -type f \( -name "*_web.pdf" -o -name "*_web.png" \) > "$temp_file_list"
        
        # Lire le fichier ligne par ligne
        while IFS= read -r file; do
            if [ -n "$file" ]; then
                if [ ! -d "$dest_subdir" ]; then
                    mkdir -p "$dest_subdir"
                fi
                cp "$file" "$dest_subdir/"
                echo "  Copie de $(basename "$file") dans $dir_name/$subdir_name"
            fi
        done < "$temp_file_list"
        
        rm "$temp_file_list"
    done
done

echo "Copie dans saintleger.org les Genealogie/Individus avec les fichiers _web : DONE"

######################

# Cr√©ation du fichier individus/index.html

# R√©pertoire source
SOURCE_DIR="/home/arnaud/Documents/Genealogie/saintleger.org/individus"
TEMPLATE_FILE="/home/arnaud/Documents/Genealogie/saintleger.org/template.html"
OUTPUT_FILE="${SOURCE_DIR}/index.html"

# Copier le template vers index.html
cp "$TEMPLATE_FILE" "$OUTPUT_FILE"

# Fichier temporaire pour le contenu
TEMP_CONTENT=$(mktemp)

# G√©n√©rer le contenu des liens
for dir in "$SOURCE_DIR"/*/; do
    # Extraire le nom du dossier (sans le chemin complet)
    nom_dossier=$(basename "$dir")
    
    # V√©rifier si le dossier contient des fichiers
    if [ -z "$(ls -A "$dir")" ]; then
        # Dossier vide - lien inactif
        echo "<span class=\"menu-item inactive\">$nom_dossier</span>" >> "$TEMP_CONTENT"
    else
        # Dossier non vide - lien actif
        echo "<a class=\"menu-item\" href=\"$nom_dossier.html\">$nom_dossier</a>" >> "$TEMP_CONTENT"
    fi
done

# Remplacer MON_TITRE
sed -i "s/MON_TITRE/Individus des diff√©rentes branches/g" "$OUTPUT_FILE"

# Cr√©er le contenu avec la balise nav
TEMP_NAV=$(mktemp)
echo "<nav>" > "$TEMP_NAV"
cat "$TEMP_CONTENT" >> "$TEMP_NAV"
echo "</nav>" >> "$TEMP_NAV"

# Remplacer MON_CONTENU avec le contenu g√©n√©r√©
sed -i "/MON_CONTENU/r $TEMP_NAV" "$OUTPUT_FILE"
sed -i "/MON_CONTENU/d" "$OUTPUT_FILE"

# Nettoyer
rm "$TEMP_NAV"
rm "$TEMP_CONTENT"

echo "‚úì Cr√©ation du fichier individus/index.html : $OUTPUT_FILE"
echo "‚úì Nombre de dossiers trait√©s : $(grep -c 'menu-item' "$OUTPUT_FILE")"

##################

# Les fichiers HTML par individus

# R√©pertoire source
SOURCE_DIR="/home/arnaud/Documents/Genealogie/saintleger.org/individus"
TEMPLATE_FILE="/home/arnaud/Documents/Genealogie/saintleger.org/template.html"

# Parcourir tous les dossiers dans le r√©pertoire
for dir in "$SOURCE_DIR"/*/; do
    # Extraire le nom du dossier (sans le chemin complet)
    nom_dossier=$(basename "$dir")
    
    # Fichier HTML √† cr√©er dans le dossier parent (individus/)
    html_file="${SOURCE_DIR}/${nom_dossier}.html"
    
    # Copier le template
    cp "$TEMPLATE_FILE" "$html_file"
    
    # G√©n√©rer le contenu dynamique
    contenu=""
    
    # D'abord, lister les fichiers √† la racine du dossier
    for file in "$dir"*; do
        if [ -f "$file" ]; then
            nom_fichier=$(basename "$file")
            contenu="${contenu}    $nom_fichier<a class=\"doc-btn\" href=\"${nom_dossier}/$nom_fichier\" target=\"_blank\">üìé Lire</a><br>\n"
        fi
    done
    
    # Ensuite, parcourir les sous-dossiers
    for subdir in "$dir"*/; do
        if [ -d "$subdir" ]; then
            sous_dossier=$(basename "$subdir")
            contenu="${contenu}    <h3>$sous_dossier</h3>\n"
            
            # Lister les fichiers dans ce sous-dossier
            fichiers_trouves=false
            for file in "$subdir"*; do
                if [ -f "$file" ]; then
                    fichiers_trouves=true
                    nom_fichier=$(basename "$file")
                    contenu="${contenu}    <a class=\"doc-btn\" href=\"${nom_dossier}/$sous_dossier/$nom_fichier\" target=\"_blank\">üìé $nom_fichier</a><br>\n"
                fi
            done
            
            # Si aucun fichier trouv√© dans ce sous-dossier, afficher un message
            if [ "$fichiers_trouves" = false ]; then
                contenu="${contenu}    <p><em>Aucun fichier dans ce dossier</em></p>\n"
            fi
        fi
    done
    
    # Si aucun contenu, afficher un message
    if [ -z "$contenu" ]; then
        contenu="    <p>Aucun document disponible.</p>\n"
    fi
    
    # Remplacer MON_TITRE par le nom du dossier
    sed -i "s/MON_TITRE/$nom_dossier/g" "$html_file"
    
    # Remplacer le placeholder du contenu
    # Cr√©er un fichier temporaire avec le contenu
    temp_content=$(mktemp)
    printf '%b' "$contenu" > "$temp_content"
    
    # Remplacer MON_CONTENU avec le contenu du fichier
    sed -i "/MON_CONTENU/r $temp_content" "$html_file"
    sed -i "/MON_CONTENU/d" "$html_file"
    
    # Nettoyer
    rm "$temp_content"
    
    echo "‚úì Cr√©√© : $html_file"
done

echo ""
echo "Termin√© ! Les fichiers HTML par individus ont √©t√© g√©n√©r√©s."
